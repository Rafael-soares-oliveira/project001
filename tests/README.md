# Tests
This folder contains tests for the project.

## Logger Tests
The logger tests file contains tests for the logger.

`test_logger_configuration`:
- Check that the logger is an instance of logging.Logger.
- Check that the logger name is "project001".
- Check that the logger level is logging.DEBUG.
- Check that the logger has the correct number of handlers
- Check that the logger file exist in the date-based directory

`test_logger_levels`:
- Check that the messages were logged to the single log gile in date-based directory
- Check that log file contains all messages at all levels

## Test Documentation for _01_raw Pipeline
This document provides a detailed overview of the unit tests for the _01_raw Kedro pipeline. The primary goal of this pipeline is to fetch raw stock and news data from external APIs.

`Test Setup and Helpers`
To create a controlled and predictable test environment, we use helper functions and pytest fixtures to generate mock data. The fixtures are centralized in `tests/conftest.py` and are available to all test files automatically.

- <b>make_fake_stock():</b> This helper function creates a sample pandas DataFrame that mimics the structure of stock data returned by the yfinance library. It includes realistic column names (Open, High, Low, Close, etc.) and intentionally contains np.nan values to test data cleaning steps in later pipelines. The DataFrame's index is a DatetimeIndex named "Date", just like the real API response.

- <b>make_fake_news():</b> This function generates a sample DataFrame representing news articles. It includes columns like title, publishedAt, and source, and also contains np.nan values to test data handling.

- <b>fake_stock and fake_news fixtures:</b> The fake_stock and fake_news fixtures make the data generated by the helper functions easily available to any test function that needs it, promoting code reuse.

`Test Class: TestRawPipeline`
All tests are organized within the TestRawPipeline class. This class uses a setup_method to define common parameters used across multiple tests, such as API keys, tickers, and date ranges, avoiding repetition.

<b>Individual Test Explanations</b>
Here is a breakdown of each test method within the class:

- <b>test_get_stock_data:</b>
- - <b>Purpose:</b> Verifies that the _get_stock_data function successfully fetches and formats stock data.
- - <b>How it works:</b> It uses @patch to replace yf.Ticker with a MagicMock. This mock is configured to return our fake_stock DataFrame when its .history() method is called. The test then asserts that the function's output is a non-empty DataFrame and contains the essential Date and ticker columns.
<br>
- <b>test_get_news_data:</b>
- - <b>Purpose:</b> Ensures _get_news_data correctly processes a successful API response for news articles.
- - <b>How it works:</b> It mocks the requests.get call. The mock response is configured with a 200 status code and a JSON body containing articles. A crucial step here is transforming the fake_news DataFrame to mimic the real NewsAPI JSON structure, including handling the nested source dictionary. The test asserts that the result is a non-empty DataFrame with the expected columns.
<br>
- <b>test_get_news_data_http_error:</b>
- - <b>Purpose:</b> Tests the function's resilience to network or API errors (e.g., authentication failure).
- - <b>How it works:</b> It mocks requests.get to simulate an HTTP error by setting the status_code to 403 and making raise_for_status() raise an HTTPError. The test asserts that the function catches this exception and correctly returns an empty DataFrame, preventing the pipeline from crashing.
<br>
- <b>test_get_stock_data_empty_result:</b>
- - <b>Purpose:</b> Checks how _get_stock_data behaves when the API returns no data for a given ticker (e.g., an invalid one).
- - <b>How it works:</b> The yf.Ticker mock is configured to return an empty DataFrame. The test asserts that the function handles this gracefully by returning an empty DataFrame itself.
<br>
- <b>test_ingest_raw_data_with_empty_fetchers:</b>
- - <b>Purpose:</b> Verifies that the main orchestrator function, ingest_raw_data, correctly handles cases where the underlying fetcher functions return no data.
- - <b>How it works:</b> Instead of mocking, this test passes in simple lambda functions as stock_fetcher and news_fetcher that directly return empty DataFrames. It then asserts that the output dictionaries (stock_data, news_data) contain empty DataFrames for each ticker.
<br>
- <b>test_ingest_multiple_tickers:</b>
- - <b>Purpose:</b> Confirms that ingest_raw_data can iterate over multiple tickers and fetch data for all of them.
- - <b>How it works:</b> It extends the setup_method to include multiple tickers. The test asserts that the output dictionaries contain keys for all the specified tickers (with . replaced by _) and that the corresponding DataFrame values are not empty.
<br>
- <b>test_stock_data_has_expected_columns:</b>
- - <b>Purpose:</b> Provides a more explicit check that the DataFrame returned by _get_stock_data contains all the necessary columns.
- - <b>How it works:</b> It defines a set of expected column names and, after calling the mocked function, asserts that this set is a subset of the columns in the resulting DataFrame. This ensures that no critical data columns are accidentally dropped.
<br>
- <b>test_news_data_has_expected_columns:</b>
- - <b>Purpose:</b> Similar to the stock data test, this ensures that the news articles DataFrame has the expected columns.
- - <b>How it works:</b> It defines a set of expected column names for news articles and checks that this set is a subset of the columns in the DataFrame returned by _get_news_data.

## Test Documentation for _02_intermediate Pipeline
This section provides a detailed overview of the unit tests for the _02_intermediate Kedro pipeline. The primary goal of this pipeline is to transform the raw data into a cleaned data without changing the original structure. These tests ensure that the data transformation and ingestion nodes (_transform_data and ingest_transformed_data) are robust and handle various scenarios correctly.

`Test Class: TestIntermediatePipeline`
All tests are organized within the TestIntermediatePipeline class. This class uses a setup_method to define common parameters used across multiple tests, such as tickers.

<b>Individual Test Explanations</b>
Here is a breakdown of each test method within the class:

- <b>test_transform_data_stock:</b>
- - <b>Purpose:</b> Verifies that the _transform_data function correctly transforms the raw stock data.
- - <b>How it works:</b> It takes the fake_stock fixture, resets its index, and passes it to the _transform_data function. The test asserts that the output is a non-empty DataFrame, that the columns are in snake_case, that there are no duplicated or NaN values, and that the DataFrame is sorted by date.
<br>
- <b>test_transform_data_news:</b>
- - <b>Purpose:</b> Verifies that the _transform_data function correctly transforms the raw news data.
- - <b>How it works:</b> It passes the fake_news fixture to the _transform_data function. The test asserts that the output is a non-empty DataFrame, that the columns are in snake_case, that there are no duplicated or NaN values, and that the DataFrame is sorted by the 'published_at' column.
<br>
- <b>test_ingest_transformed_data:</b>
- - <b>Purpose:</b> Ensures that the ingest_transformed_data function correctly ingests the transformed data.
- - <b>How it works:</b> It creates mock raw_stock and raw_news dictionaries containing the fake data and passes them to the ingest_transformed_data function. The test asserts that the output dictionaries are not empty.
<br>
- <b>test_ingest_transformed_data_missing_ticker:</b>
- - <b>Purpose:</b> Tests the function's ability to handle missing tickers gracefully.
- - <b>How it works:</b> It provides a raw_news dictionary that is empty and asserts that the function returns an empty dictionary for the news data while still processing the stock data.
<br>
- <b>test_ingest_transformed_data_empty_dataframe:</b>
- - <b>Purpose:</b> Checks how the function behaves when it receives an empty DataFrame.
- - <b>How it works:</b> It provides a raw_stock dictionary that returns an empty DataFrame and asserts that the function handles this by returning an empty dictionary for the stock data.
<br>
- <b>test_ingest_transformed_data_loader_exception:</b>
- - <b>Purpose:</b> Verifies that the function can handle exceptions during data loading.
- - <b>How it works:</b> It uses a mock loader that raises a ValueError and asserts that the function catches the exception and returns an empty dictionary for the stock data.


## Test Documentation for _03_primary Pipeline
This section provides a detailed overview of the unit tests for the _03_primary Kedro pipeline. The primary goal of this pipeline is to transform the cleaned data into a format that is ready for analysis without adding any new columns. These tests ensure that the data transformation and ingestion nodes (_apply_transformers and ingest_transformed_data) are robust and handle various scenarios correctly.

`Test Class: TestPrimaryPipeline`
All tests are organized within the TestPrimaryPipeline class. This class uses a setup_method to define common parameters used across multiple tests, such as tickers.

<b>Individual Test Explanations</b>
Here is a breakdown of each test method within the class:

- <b>test_remove_columns:</b>
- - <b>Purpose:</b> Verifies that the _remove_columns transformer correctly removes specified columns from the DataFrame.
- - <b>How it works:</b> It creates a sample DataFrame with multiple columns and applies the _remove_columns transformer with a list of columns to remove. The test asserts that the resulting DataFrame no longer contains the specified columns.

- <b>test_lower_case_text_columns:</b>
- - <b>Purpose:</b> Ensures that the _lower_case_text_columns transformer correctly converts text columns to lowercase.
- - <b>How it works:</b> It creates a sample DataFrame with text columns and applies the _lower_case_text_columns transformer. The test asserts that all text columns in the resulting DataFrame are in lowercase.

- <b>test_round_numeric_columns:</b>
- - <b>Purpose:</b> Verifies that the _round_numeric_columns transformer correctly float values to 2 decimal places.
- - <b>How it works:</b> It creates a sample DataFrame with numeric columns and applies the _round_numeric_columns transformer. The test asserts that all numeric columns in the resulting DataFrame have been rounded to 2 decimal places.

- <b>test_format_date_columns:</b>
- - <b>Purpose:</b> Ensures that the _format_date_columns transformer correctly formats date columns to the 'YYYY-MM-DD' format.
- - <b>How it works:</b> It creates a sample DataFrame with date columns and applies the _format_date_columns transformer. The test asserts that all date columns in the resulting DataFrame have been formatted to the 'YYYY-MM-DD' format.

- <b>test_transform_data_stock:</b>
- - <b>Purpose:</b> Verifies that the _apply_transformers function correctly transforms the raw stock data.
- - <b>How it works:</b> It takes the fake_stock fixture, and passes it to the _apply_transformers function. The test asserts that the all the transformers are applied to the stock data.

- <b>test_transform_data_news:</b>
- - <b>Purpose:</b> Verifies that the _apply_transformers function correctly transforms the raw news data.
- - <b>How it works:</b> It passes the fake_news fixture to the _apply_transformers function. The test asserts that the all the transformers are applied to the news data.

- <b>test_ingest_transformed_data_success:</b>
- - <b>Purpose:</b> Ensures that the ingest_transformed_data function correctly ingests the transformed data.
- - <b>How it works:</b> It creates mock raw_stock and raw_news dictionaries containing the fake data and passes them to the ingest_transformed_data function. The test asserts that the output dictionaries are not empty and all functions are applied correctly.
